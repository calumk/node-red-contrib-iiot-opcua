"use strict";module.exports=function(a){require("source-map-support").install();var b=require("./core/opcua-iiot-core-client");a.nodes.registerType("OPCUA-IIoT-Read",function(e){a.nodes.createNode(this,e),this.attributeId=parseInt(e.attributeId)||0,this.maxAge=parseInt(e.maxAge)||1,this.depth=parseInt(e.depth)||1,this.name=e.name,this.justValue=e.justValue,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.parseStrings=e.parseStrings,this.historyDays=parseInt(e.historyDays)||1,this.serverMaxItemsToRead=parseInt(e.serverMaxItemsToRead)||1e3,this.connector=a.nodes.getNode(e.connector);var h=b.core.initClientNode(this);b.core.assert(h.bianco.iiot),h.bianco.iiot.handleReadError=function(e,t){b.readDebugLog(e),h.showErrors&&h.error(e,t),b.core.isSessionBad(e)&&h.emit("opcua_client_not_ready")},h.bianco.iiot.readAllFromNodeId=function(e,t,i){for(var o=[],a=[],r=parseInt(.01*h.serverMaxItemsToRead)||10;0<t.length;)o=t.slice(0,r),a.push(t.slice(0,r)),t=t.slice(r),b.readAllAttributes(e,o,i).then(function(t){try{h.send(h.bianco.iiot.buildResultMessage("AllAttributes",t))}catch(e){h.bianco.iiot.handleReadError(e,t.msg)}}).catch(function(e){b.core.isInitializedBiancoIIoTNode(h)?h.bianco.iiot.handleReadError(e,i):b.internalDebugLog(e.message)})},h.bianco.iiot.readValueFromNodeId=function(e,t,i){for(var o=[],a=[];0<t.length;)o=t.slice(0,h.serverMaxItemsToRead-1),a.push(t.slice(0,h.serverMaxItemsToRead-1)),t=t.slice(h.serverMaxItemsToRead),b.readVariableValue(e,o,i).then(function(e){var t=h.bianco.iiot.buildResultMessage("VariableValue",e);h.send(t)}).catch(function(e){b.core.isInitializedBiancoIIoTNode(h)?h.bianco.iiot.handleReadError(e,i):b.internalDebugLog(e.message)})},h.bianco.iiot.readHistoryDataFromNodeId=function(e,t,i){var o=new Date;h.bianco.iiot.historyStart=new Date,h.bianco.iiot.historyStart.setDate(o.getDate()-h.historyDays),h.bianco.iiot.historyEnd=new Date;for(var a=[],r=[];0<t.length;)a=t.slice(0,h.serverMaxItemsToRead-1),r.push(t.slice(0,h.serverMaxItemsToRead-1)),t=t.slice(h.serverMaxItemsToRead),b.readHistoryValue(e,a,i.payload.historyStart||h.bianco.iiot.historyStart,i.payload.historyEnd||h.bianco.iiot.historyEnd,i).then(function(e){var t=h.bianco.iiot.buildResultMessage("HistoryValue",e);t.historyStart=e.startDate||h.bianco.iiot.historyStart,t.historyEnd=e.endDate||h.bianco.iiot.historyEnd,h.send(t)}).catch(function(e){b.core.isInitializedBiancoIIoTNode(h)?h.bianco.iiot.handleReadError(e,i):b.internalDebugLog(e.message)})},h.bianco.iiot.readFromNodeId=function(e,t,i){var o=null,a=[],r=!0,s=!1,n=void 0;try{for(var c,d=t[Symbol.iterator]();!(r=(c=d.next()).done);r=!0)o={nodeId:c.value,attributeId:Number(h.attributeId)||null},a.push(o)}catch(e){s=!0,n=e}finally{try{r||null==d.return||d.return()}finally{if(s)throw n}}t=a;for(var u=[],l=[];0<t.length;)u=t.slice(0,h.serverMaxItemsToRead-1),l.push(t.slice(0,h.serverMaxItemsToRead-1)),t=t.slice(h.serverMaxItemsToRead),b.read(e,u,i.payload.maxAge||h.maxAge,i).then(function(e){var t=h.bianco.iiot.buildResultMessage("Default",e);t.maxAge=h.maxAge,h.send(t)}).catch(function(e){b.core.isInitializedBiancoIIoTNode(h)?h.bianco.iiot.handleReadError(e,i):b.internalDebugLog(e.message)})},h.bianco.iiot.readFromSession=function(t,i,e){var o=Object.assign({},e);b.core.checkSessionNotValid(t,"Reader")||(b.readDebugLog("Read With AttributeId "+h.attributeId),new Promise(function(e){switch(parseInt(h.attributeId)){case b.READ_TYPE.ALL:h.bianco.iiot.readAllFromNodeId(t,i,o);break;case b.READ_TYPE.VALUE:h.bianco.iiot.readValueFromNodeId(t,i,o);break;case b.READ_TYPE.HISTORY:h.bianco.iiot.readHistoryDataFromNodeId(t,i,o);break;default:h.bianco.iiot.readFromNodeId(t,i,o)}e()}).then(function(){h.showStatusActivities&&b.core.setNodeStatusTo(h,"active")}))},h.bianco.iiot.buildResultMessage=function(e,t){var i=Object.assign({},t.msg);i.payload={},i.nodetype="read",i.readtype=e,i.attributeId=h.attributeId,i.justValue=h.justValue;var o=h.bianco.iiot.extractDataValueString(t);return i=h.bianco.iiot.setMessageProperties(i,t,o),h.justValue||(i=h.bianco.iiot.enhanceMessage(i,t)),i},h.bianco.iiot.extractDataValueString=function(e){return h.justValue?JSON.stringify(e.results,null,2):JSON.stringify(e,null,2)},h.bianco.iiot.setMessageProperties=function(t,i,o){try{a.util.setMessageProperty(t,"payload",JSON.parse(o))}catch(e){h.showErrors&&(h.warn("JSON not to parse from string for dataValues type "+JSON.stringify(i,null,2)),h.error(e,i.msg)),t.payload=o,t.error=e.message}return t},h.bianco.iiot.enhanceMessage=function(t,i){try{t.resultsConverted={};var e=JSON.stringify(i.results,null,2);a.util.setMessageProperty(t,"resultsConverted",JSON.parse(e))}catch(e){h.showErrors&&(h.warn("JSON not to parse from string for dataValues type "+i.results),h.error(e,i.msg)),t.resultsConverted=null,t.error=e.message}return t},h.on("input",function(t){if(b.core.checkConnectorState(h,t,"Read")){h.showStatusActivities&&b.core.setNodeStatusTo(h,"reading");try{h.bianco.iiot.readFromSession(h.bianco.iiot.opcuaSession,b.core.buildNodesToRead(t),t)}catch(e){h.bianco.iiot.handleReadError(e,t)}}}),b.core.registerToConnector(h),h.on("close",function(e){b.core.deregisterToConnector(h,function(){b.core.resetBiancoNode(h),e()})})})};
//# sourceMappingURL=maps/opcua-iiot-read.js.map
